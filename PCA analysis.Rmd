---
title: "PCA analysis"
author: "Jieqi Tu, jt3098"
date: "11/16/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r Import data}
# Import datasets
ABC_total_raw = readxl::read_excel("./ABC_Cord Blood_Metabolomics_new.xlsx") %>% as.data.frame()

# Tidy dataset
ABC_total = 
  ABC_total_raw %>% 
  janitor::clean_names()

# Divide the dataset to confounding information and experimental data
ABC_information = ABC_total[1:10]
ABC_data = ABC_total[11:930]

# Make a copy of ABC_data
ABC_data_orginal = ABC_data
```

```{r principal component analysis}
# Principal component analysis
ABC_pca = prcomp(ABC_total[c(11:930)], center = T, scale. = T)
summary(ABC_pca)

# Plot PC1 and PC2
library(ggfortify)
autoplot(ABC_pca, label = T, label.size = 3)
```


```{r scale the data}
# Extract the subset of all controls
subset_control = 
  ABC_total %>% 
  group_by(strata) %>% 
  filter(asd == 0)

# Calculate the mean and standard deviation of the control group
mean_control = sapply(subset_control[11:930], function(x) mean(x)) 
sd_control = sapply(subset_control[11:930], function(x) sd(x))

# Write a for-loop to calculate z-score of data for both control and ASD groups
for(i in 11:930) {
  ABC_logtrans[i] = (ABC_logtrans[i] - mean_control[i-10])/sd_control[i-10]
}
```

```{r principal component analysis}
# Principal component analysis
ABC_pca = prcomp(ABC_logtrans[c(11:930)], center = F, scale. = F)
summary(ABC_pca)

# Plot PC1 and PC2
plot(ABC_pca$x[,1],ABC_pca$x[,2], xlab="PC1 (9.6%)", ylab = "PC2 (8.7%)", main = "PC1 / PC2 - plot")
```

```{r log transformation}
# Convert 0 to NA and add 1 to columns that contains 0
ABC_data[ABC_data == 0] = NA
NA_value = sapply(ABC_data[1:920], function(x) sum(which(is.na(x))))

for(i in 1:920) {
  if(NA_value[i]>0) {
    ABC_data_orginal[i] = ABC_data_orginal[i] + 1
  }
}


# Base 10 log transformation of original data
ABC_data = sapply(ABC_data_orginal[1:920], function(x) log10(x))
ABC_logtrans = cbind.data.frame(ABC_information, ABC_data)
```

